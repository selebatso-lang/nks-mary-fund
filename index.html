<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè¶NKS & MARY FUND - WhatsApp Integrated</title>
    <style>
        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --gray-color: #95a5a6;
            --whatsapp-color: #25D366;
            --whatsapp-dark: #128C7E;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header & Navigation */
        header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            font-size: 2.5rem;
            color: var(--primary-color);
        }

        .logo h1 {
            color: var(--primary-color);
            font-size: 1.8rem;
        }

        nav button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: var(--secondary-color);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 10px;
        }

        nav button:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
        }

        /* Main Content Area */
        .main-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .active-content {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Login Page */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .login-container h2 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--dark-color);
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--secondary-color);
            outline: none;
        }

        /* Dashboard */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--light-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--light-color);
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            transition: transform 0.3s;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .stat-card p {
            color: var(--gray-color);
            font-weight: 600;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        thead {
            background: var(--primary-color);
            color: white;
        }

        tbody tr {
            transition: background 0.3s;
        }

        tbody tr:hover {
            background: var(--light-color);
        }

        .paid {
            color: var(--success-color);
            font-weight: bold;
        }

        .unpaid {
            color: var(--danger-color);
            font-weight: bold;
        }

        .partial {
            color: var(--warning-color);
            font-weight: bold;
        }

        /* Forms */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        /* WhatsApp Specific */
        .whatsapp-btn {
            background: var(--whatsapp-color) !important;
            color: white !important;
        }

        .whatsapp-btn:hover {
            background: var(--whatsapp-dark) !important;
            transform: translateY(-2px);
        }

        .whatsapp-badge {
            background: var(--whatsapp-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 5px;
        }

        .whatsapp-qr {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid var(--whatsapp-color);
        }

        .whatsapp-qr canvas {
            margin: 10px auto;
            display: block;
        }

        .broadcast-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid var(--whatsapp-color);
        }

        .message-template {
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Segoe UI', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            background: #f8fff8;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--light-color);
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-color);
            transition: all 0.3s;
            position: relative;
        }

        .tab.active {
            color: var(--secondary-color);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--secondary-color);
        }

        /* Payment Methods */
        .payment-methods {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .payment-method {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: var(--light-color);
            border-radius: 20px;
            font-weight: 600;
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .mt-1 { margin-top: 10px; }
        .mt-2 { margin-top: 20px; }
        .mt-3 { margin-top: 30px; }
        .mt-4 { margin-top: 40px; }
        .mb-1 { margin-bottom: 10px; }
        .mb-2 { margin-bottom: 20px; }
        .mb-3 { margin-bottom: 30px; }
        .mb-4 { margin-bottom: 40px; }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            nav button {
                margin: 5px;
                width: 100%;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                text-align: left;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container" id="app">
        <!-- Login Screen -->
        <div id="loginScreen" class="login-container">
            <h2><i class="fas fa-hands-helping"></i> üè¶NKS & MARY FUND</h2>
            <p class="text-center mb-3">
                <span class="whatsapp-badge">
                    <i class="fab fa-whatsapp"></i> WhatsApp Integrated
                </span>
            </p>
            
            <div id="adminLogin" class="hidden">
                <h3>Admin Login</h3>
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label for="password">Passwordüîê</label>
                    <input type="password" id="password" placeholder="Enter password">
                </div>
                <button onclick="login()" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i> Login as Admin
                </button>
                <p class="text-center mt-3">
                    <a href="#" onclick="showMemberAccess()">Family Member Access</a> |
                    <a href="#" onclick="showWhatsAppAccess()"><i class="fab fa-whatsapp"></i> WhatsApp Access</a>
                </p>
            </div>

            <div id="memberAccess">
                <h3>Family Member Access</h3>
                <div class="form-group">
                    <label for="memberCode">Your Access Code</label>
                    <input type="text" id="memberCode" placeholder="Enter code from WhatsApp">
                </div>
                <button onclick="accessAsMember()" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-eye"></i> View Status
                </button>
                <div class="text-center mt-3">
                    <p>Or access via WhatsApp:</p>
                    <button onclick="accessViaWhatsApp()" class="btn whatsapp-btn" style="width: 100%;">
                        <i class="fab fa-whatsapp"></i> Open WhatsApp
                    </button>
                </div>
                <p class="text-center mt-3">
                    <a href="#" onclick="showAdminLogin()">Admin Login</a>
                </p>
            </div>
            
            <!-- WhatsApp Access Section -->
            <div id="whatsappAccess" class="hidden">
                <h3><i class="fab fa-whatsapp"></i> WhatsApp Access</h3>
                <p>Use WhatsApp to check your status anytime:</p>
                
                <div class="whatsapp-qr">
                    <h4>Scan to Save Link</h4>
                    <div id="qrcode"></div>
                    <p class="mt-2"><small>Scan with WhatsApp camera</small></p>
                </div>
                
                <div class="form-group">
                    <label>Your WhatsApp Number:</label>
                    <input type="tel" id="whatsappNumber" placeholder="+267 XXX XXXX" value="+267">
                </div>
                
                <button onclick="sendWhatsAppLink()" class="btn whatsapp-btn" style="width: 100%;">
                    <i class="fab fa-whatsapp"></i> Send Link to My WhatsApp
                </button>
                
                <div class="mt-3">
                    <h5>WhatsApp Commands:</h5>
                    <div class="message-template">
Send: STATUS [YOUR-CODE]
Example: STATUS KAYTOR001
                    </div>
                    <p class="text-center mt-2"><small>Save this number: <strong>+267 76781005</strong></small></p>
                </div>
                
                <p class="text-center mt-3">
                    <a href="#" onclick="showAdminLogin()">Admin Login</a> |
                    <a href="#" onclick="showMemberAccess()">Enter Code</a>
                </p>
            </div>
        </div>

        <!-- Main App Screen -->
        <div id="appScreen" class="hidden">
            <header>
                <div class="logo">
                    <i class="fas fa-hands-helping"></i>
                    <div>
                        <h1>üè¶NKS & MARY FUND <span class="whatsapp-badge">WhatsApp</span></h1>
                        <p id="currentUserRole">Administrator</p>
                    </div>
                </div>
                <nav>
                    <button onclick="showScreen('dashboard')" id="navDashboard">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </button>
                    <button onclick="showScreen('members')" id="navMembers">
                        <i class="fas fa-users"></i> Members
                    </button>
                    <button onclick="showScreen('payments')" id="navPayments">
                        <i class="fas fa-money-bill-wave"></i> Payments
                    </button>
                    <button onclick="showScreen('reports')" id="navReports">
                        <i class="fas fa-chart-bar"></i> Reports
                    </button>
                    <button onclick="showScreen('whatsapp')" id="navWhatsApp" class="whatsapp-btn">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </button>
                    <button onclick="logout()" class="btn-danger">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </nav>
            </header>

            <!-- Dashboard Screen -->
            <div id="dashboardScreen" class="main-content">
                <div class="dashboard-header">
                    <h2>Dashboard Overview</h2>
                    <div>
                        <strong>Current Month:</strong> <span id="currentMonth"></span>
                    </div>
                </div>

                <div class="text-right mb-3">
                    <button onclick="sendWhatsAppRemindersToAll()" class="btn whatsapp-btn">
                        <i class="fab fa-whatsapp"></i> Send WhatsApp Reminders
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="totalMembers">0</h3>
                        <p>Total Family Members</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalBalance">P0</h3>
                        <p>Total Fund Balance</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="paidThisMonth">0</h3>
                        <p>Paid This Month</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="unpaidThisMonth">0</h3>
                        <p>Unpaid This Month</p>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="showDashboardTab('summary')">Summary</button>
                    <button class="tab" onclick="showDashboardTab('recentPayments')">Recent Payments</button>
                    <button class="tab" onclick="showDashboardTab('unpaidMembers')">Unpaid Members</button>
                </div>

                <div id="dashboardSummary" class="dashboard-tab">
                    <h3>Monthly Payment Status</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Member</th>
                                <th>Monthly Target</th>
                                <th>Paid This Month</th>
                                <th>Status</th>
                                <th>Balance</th>
                                <th>WhatsApp</th>
                            </tr>
                        </thead>
                        <tbody id="dashboardTableBody">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div id="dashboardRecentPayments" class="dashboard-tab hidden">
                    <h3>Recent Payments</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Member</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>For Month</th>
                                <th>WhatsApp</th>
                            </tr>
                        </thead>
                        <tbody id="recentPaymentsBody">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div id="dashboardUnpaidMembers" class="dashboard-tab hidden">
                    <h3>Members Yet to Pay This Month</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Member</th>
                                <th>Phone</th>
                                <th>Monthly Target</th>
                                <th>WhatsApp</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="unpaidMembersBody">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Members Management Screen -->
            <div id="membersScreen" class="main-content hidden">
                <div class="dashboard-header">
                    <h2>Manage Family Members</h2>
                    <button onclick="showAddMemberForm()" class="btn btn-success">
                        <i class="fas fa-user-plus"></i> Add Member
                    </button>
                </div>

                <div id="addMemberForm" class="hidden mb-3">
                    <h3>Add New Family Member</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newMemberName">Full Name</label>
                            <input type="text" id="newMemberName" placeholder="Enter full name">
                        </div>
                        <div class="form-group">
                            <label for="newMemberPhone">Phone Number</label>
                            <input type="tel" id="newMemberPhone" placeholder="Enter phone number">
                        </div>
                        <div class="form-group">
                            <label for="newMemberEmail">Email (Optional)</label>
                            <input type="email" id="newMemberEmail" placeholder="Enter email">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newMemberMonthly">Monthly Contribution</label>
                            <input type="number" id="newMemberMonthly" placeholder="Monthly amount" value="50">
                        </div>
                        <div class="form-group">
                            <label for="newMemberRelationship">Relationship</label>
                            <select id="newMemberRelationship">
                                <option value="Immediate">1st Generation</option>
                                <option value="Extended">2nd Generation</option>
                                <option value="Friend">3rd & Other Generation</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Payment Methods</label>
                            <div class="payment-methods">
                                <label><input type="checkbox" name="paymentMethod" value="MyZaka" checked> MyZaka</label>
                                <label><input type="checkbox" name="paymentMethod" value="Orange Money" checked> Orange Money</label>
                                <label><input type="checkbox" name="paymentMethod" value="Smega" checked> Smega</label>
                                <label><input type="checkbox" name="paymentMethod" value="Ewallet" checked> Ewallet</label>
                                <label><input type="checkbox" name="paymentMethod" value="Cash"> Cash</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <button onclick="addNewMember()" class="btn btn-success">
                            <i class="fas fa-save"></i> Save Member
                        </button>
                        <button onclick="hideAddMemberForm()" class="btn btn-danger">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>

                <div id="editMemberForm" class="hidden mb-3">
                    <!-- Edit form will be populated by JavaScript -->
                </div>

                <h3>All Family Members</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Monthly Amount</th>
                            <th>Payment Methods</th>
                            <th>Joined Date</th>
                            <th>Status</th>
                            <th>WhatsApp</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="membersTableBody">
                        <!-- Filled by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Payments Screen -->
            <div id="paymentsScreen" class="main-content hidden">
                <div class="dashboard-header">
                    <h2>Record Payments</h2>
                    <button onclick="showRecordPaymentForm()" class="btn btn-success">
                        <i class="fas fa-plus-circle"></i> Record Payment
                    </button>
                </div>

                <div id="recordPaymentForm" class="hidden mb-3">
                    <h3>Record New Payment</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="paymentMember">Select Member</label>
                            <select id="paymentMember">
                                <!-- Filled by JavaScript -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="paymentAmount">Amount</label>
                            <input type="number" id="paymentAmount" placeholder="Enter amount">
                        </div>
                        <div class="form-group">
                            <label for="paymentDate">Payment Date</label>
                            <input type="date" id="paymentDate">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="paymentMethod">Payment Method</label>
                            <select id="paymentMethod">
                                <option value="MyZaka">MyZaka</option>
                                <option value="Orange Money">Orange Money</option>
                                <option value="Smega">Smega</option>
                                <option value="Ewallet">Ewallet</option>
                                <option value="Cash">Cash</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="paymentReference">Reference Number</label>
                            <input type="text" id="paymentReference" placeholder="Transaction ID or reference">
                        </div>
                        <div class="form-group">
                            <label for="paymentMonth">For Month</label>
                            <select id="paymentMonth">
                                <!-- Filled by JavaScript -->
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="paymentNotes">Notes (Optional)</label>
                            <textarea id="paymentNotes" rows="3" placeholder="Any additional notes"></textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <button onclick="recordPayment()" class="btn btn-success">
                            <i class="fas fa-check-circle"></i> Record Payment
                        </button>
                        <button onclick="hideRecordPaymentForm()" class="btn btn-danger">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                    
                    <div id="whatsappConfirmation" class="hidden mt-3">
                        <h4><i class="fab fa-whatsapp"></i> Send Payment Confirmation</h4>
                        <div class="form-group">
                            <label>Confirmation Message:</label>
                            <textarea id="whatsappConfirmationMsg" rows="3" class="form-control" readonly></textarea>
                        </div>
                        <button onclick="sendPaymentConfirmation()" class="btn whatsapp-btn">
                            <i class="fab fa-whatsapp"></i> Send to Member
                        </button>
                    </div>
                </div>

                <h3>Payment History</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="filterMonth">Filter by Month</label>
                        <select id="filterMonth" onchange="filterPayments()">
                            <option value="all">All Months</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filterMember">Filter by Member</label>
                        <select id="filterMember" onchange="filterPayments()">
                            <option value="all">All Members</option>
                        </select>
                    </div>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Member</th>
                            <th>Amount</th>
                            <th>Method</th>
                            <th>Reference</th>
                            <th>For Month</th>
                            <th>Recorded By</th>
                            <th>WhatsApp</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTableBody">
                        <!-- Filled by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Reports Screen -->
            <div id="reportsScreen" class="main-content hidden">
                <div class="dashboard-header">
                    <h2>Reports & Analytics</h2>
                    <button onclick="generateMonthlyReport()" class="btn btn-primary">
                        <i class="fas fa-file-pdf"></i> Generate Report
                    </button>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="showReportTab('monthly')">Monthly Summary</button>
                    <button class="tab" onclick="showReportTab('memberStats')">Member Statistics</button>
                    <button class="tab" onclick="showReportTab('paymentMethods')">Payment Methods</button>
                </div>

                <div id="monthlyReport" class="report-tab">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="reportMonth">Select Month</label>
                            <select id="reportMonth" onchange="loadMonthlyReport()">
                                <!-- Filled by JavaScript -->
                            </select>
                        </div>
                    </div>

                    <div id="monthlyReportContent">
                        <h3 id="selectedMonthTitle"></h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3 id="reportTotalMembers">0</h3>
                                <p>Total Members</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="reportTotalCollected">P0</h3>
                                <p>Total Collected</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="reportExpectedAmount">P0</h3>
                                <p>Expected Amount</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="reportCollectionRate">0%</h3>
                                <p>Collection Rate</p>
                            </div>
                        </div>

                        <h4>Payment Status</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>Member</th>
                                    <th>Expected</th>
                                    <th>Paid</th>
                                    <th>Balance</th>
                                    <th>Status</th>
                                    <th>WhatsApp</th>
                                </tr>
                            </thead>
                            <tbody id="monthlyReportBody">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="memberStatsReport" class="report-tab hidden">
                    <h3>Member Contribution History</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="selectMemberStats">Select Member</label>
                            <select id="selectMemberStats" onchange="loadMemberStats()">
                                <!-- Filled by JavaScript -->
                            </select>
                        </div>
                    </div>

                    <div id="memberStatsContent">
                        <h4 id="memberStatsName"></h4>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3 id="memberTotalPaid">P0</h3>
                                <p>Total Paid</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="memberMonthsPaid">0</h3>
                                <p>Months Paid</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="memberCurrentBalance">P0</h3>
                                <p>Current Balance</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="memberPaymentRate">0%</h3>
                                <p>Payment Rate</p>
                            </div>
                        </div>

                        <h4>Payment History</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="memberHistoryBody">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="paymentMethodsReport" class="report-tab hidden">
                    <h3>Payment Method Analysis</h3>
                    <div id="paymentMethodsChart">
                        <canvas id="methodsChart" width="400" height="200"></canvas>
                    </div>
                    <table class="mt-3">
                        <thead>
                            <tr>
                                <th>Payment Method</th>
                                <th>Number of Transactions</th>
                                <th>Total Amount</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody id="paymentMethodsBody">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- WhatsApp Screen -->
            <div id="whatsappScreen" class="main-content hidden">
                <div class="dashboard-header">
                    <h2><i class="fab fa-whatsapp"></i> WhatsApp Broadcast & Automation</h2>
                    <button onclick="testWhatsAppIntegration()" class="btn whatsapp-btn">
                        <i class="fas fa-test"></i> Test Integration
                    </button>
                </div>

                <!-- Broadcast Panel -->
                <div class="broadcast-panel">
                    <h3>Send Broadcast Message</h3>
                    <div class="form-group">
                        <label>Message Template:</label>
                        <select id="broadcastTemplate" class="form-control" onchange="loadBroadcastTemplate()">
                            <option value="custom">Custom Message</option>
                            <option value="payment_reminder">Payment Reminder</option>
                            <option value="payment_thanks">Payment Thank You</option>
                            <option value="monthly_report">Monthly Report</option>
                            <option value="welcome">Welcome Message</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Message Content:</label>
                        <textarea id="broadcastMessage" rows="5" class="form-control" placeholder="Type your message..."></textarea>
                        <small class="text-muted">Use {name} for member's name, {amount} for monthly amount, {code} for access code</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Send To:</label>
                            <select id="broadcastRecipients" class="form-control">
                                <option value="all">All Active Members</option>
                                <option value="unpaid">Unpaid This Month</option>
                                <option value="paid">Paid This Month</option>
                                <option value="immediate">1st Generation Only</option>
                                <option value="extended">2nd Generation Only</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Schedule:</label>
                            <select id="broadcastSchedule" class="form-control">
                                <option value="now">Send Now</option>
                                <option value="tomorrow">Tomorrow 9 AM</option>
                                <option value="monthly_25">25th of Every Month</option>
                                <option value="monthly_30">30th of Every Month</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button onclick="sendBroadcast()" class="btn whatsapp-btn">
                            <i class="fab fa-whatsapp"></i> Send Broadcast
                        </button>
                        <button onclick="previewBroadcast()" class="btn btn-primary">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                    </div>
                </div>

                <!-- WhatsApp Quick Actions -->
                <div class="stats-grid mt-4">
                    <div class="stat-card" onclick="sendRemindersToUnpaid()" style="cursor: pointer;">
                        <h3><i class="fab fa-whatsapp"></i></h3>
                        <p>Remind Unpaid Members</p>
                    </div>
                    
                    <div class="stat-card" onclick="sendMonthlyReports()" style="cursor: pointer;">
                        <h3><i class="fas fa-file-pdf"></i></h3>
                        <p>Send Monthly Reports</p>
                    </div>
                    
                    <div class="stat-card" onclick="shareAppLink()" style="cursor: pointer;">
                        <h3><i class="fas fa-share-alt"></i></h3>
                        <p>Share App Link</p>
                    </div>
                    
                    <div class="stat-card" onclick="generateQRCode()" style="cursor: pointer;">
                        <h3><i class="fas fa-qrcode"></i></h3>
                        <p>Generate QR Code</p>
                    </div>
                </div>

                <!-- Recent WhatsApp Messages -->
                <div class="mt-4">
                    <h3>Recent WhatsApp Messages</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Member</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="whatsappHistoryBody">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- WhatsApp Settings -->
                <div class="mt-4">
                    <h3>WhatsApp Settings</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Auto-reminder Days:</label>
                            <input type="number" id="reminderDays" min="1" max="30" value="5" class="form-control">
                            <small>Days before month-end to send reminders</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Payment Confirmation:</label>
                            <select id="autoConfirm" class="form-control">
                                <option value="yes">Auto-send on payment</option>
                                <option value="no">Manual only</option>
                            </select>
                        </div>
                    </div>
                    
                    <button onclick="saveWhatsAppSettings()" class="btn btn-success">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
            </div>

            <!-- Member View Screen -->
            <div id="memberViewScreen" class="main-content hidden">
                <div class="dashboard-header">
                    <h2>Family Fund Status</h2>
                    <p id="viewingAsMember">Viewing as: <span id="memberViewName"></span></p>
                </div>

                <div class="alert alert-success">
                    <i class="fas fa-info-circle"></i> 
                    This is a read-only view. Payments must be made directly to administrators.
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="memberPersonalPaid">P0</h3>
                        <p>Your Total Paid</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="memberCurrentStatus">Unpaid</h3>
                        <p>This Month Status</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="memberMonthlyAmount">P0</h3>
                        <p>Monthly Amount</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="memberViewBalance">P0</h3>
                        <p>Fund Total Balance</p>
                    </div>
                </div>

                <!-- WhatsApp Actions for Member -->
                <div class="text-center mt-3">
                    <h4>WhatsApp Actions</h4>
                    <div class="payment-methods">
                        <button onclick="shareMyStatus()" class="btn whatsapp-btn">
                            <i class="fab fa-whatsapp"></i> Share My Status
                        </button>
                        <button onclick="requestPaymentReminder()" class="btn btn-primary">
                            <i class="fas fa-bell"></i> Request Reminder
                        </button>
                        <button onclick="contactAdminWhatsApp()" class="btn btn-secondary">
                            <i class="fas fa-headset"></i> Contact Admin
                        </button>
                    </div>
                    
                    <!-- WhatsApp QR Code for Member -->
                    <div class="whatsapp-qr mt-3">
                        <h5>Your Personal QR Code</h5>
                        <div id="memberQRCode"></div>
                        <p><small>Scan to save your personal status link</small></p>
                    </div>
                </div>

                <h3>Your Payment History</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Amount</th>
                            <th>Method</th>
                            <th>Date Paid</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="memberPersonalHistory">
                        <!-- Filled by JavaScript -->
                    </tbody>
                </table>

                <h3 class="mt-3">Family Payment Status (Current Month)</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Family Member</th>
                            <th>Monthly Amount</th>
                            <th>Paid This Month</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="familyStatusTable">
                        <!-- Filled by JavaScript -->
                    </tbody>
                </table>

                <div class="payment-methods mt-3">
                    <h4>Accepted Payment Methods:</h4>
                    <p>
                        <span class="payment-method"><i class="fas fa-mobile-alt"></i> MyZaka</span>
                        <span class="payment-method"><i class="fas fa-money-bill-wave"></i> Orange Money</span>
                        <span class="payment-method"><i class="fas fa-wallet"></i> Smega</span>
                        <span class="payment-method"><i class="fas fa-credit-card"></i> Ewallet</span>
                        <span class="payment-method"><i class="fas fa-money-bill"></i> Cash</span>
                    </p>
                    <p class="text-center mt-3">
                        <strong>Due Date:</strong> Payments Reflect Last Day Of The Month
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <!-- Add Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // WhatsApp Configuration
        const WHATSAPP_CONFIG = {
            phoneNumber: "+26776781005",
            businessName: "NKS & MARY FUND",
            autoReminders: true,
            paymentConfirmations: true,
            reminderDays: 5,
            templates: {
                payment_reminder: `üè¶ {business} Payment Reminder\n\nHello {firstName},\n\nYour {month} contribution of P{amount} is due.\nDue: End of month\n\nYour code: {code}\nStatus: {link}\n\nPay to: {adminPhone}`,
                payment_thanks: `‚úÖ {business} Payment Received\n\nThank you {firstName}!\n\nPayment: P{paidAmount}\nMonth: {month}\nBalance: P{balance}\n\nYour code: {code}\nView: {link}`,
                welcome: `üéâ Welcome to {business}\n\nHello {name},\n\nYou're now registered!\nMonthly: P{amount}\nYour code: {code}\n\nAccess: {link}\nContact: {adminPhone}`,
                monthly_report: `üìä {business} Monthly Report\n\n{month} Summary:\nMembers: {totalMembers}\nCollected: P{collected}\nExpected: P{expected}\nRate: {rate}%\n\nYour status: {link}`
            }
        };

        // Data Storage
        let currentUser = null;
        let isAdmin = false;
        let currentMember = null;

        // Default Admins
        const ADMINS = [
            { username: 'Mmaluttie', password: 'Treasurer', name: 'Treasurer' },
            { username: 'Mpene', password: 'Secretary', name: 'Secretary' }
        ];

        // Initialize Data
        function initializeData() {
            if (!localStorage.getItem('funeralFundMembers')) {
                const sampleMembers = [
                    {
                        id: 1,
                        name: 'Kaytor Selebatso',
                        phone: '+26776781005',
                        email: 'selebatso@gmail.com',
                        monthlyAmount: 10,
                        relationship: 'Immediate',
                        joinDate: '2026-01-01',
                        paymentMethods: ['MyZaka', 'Orange Money', 'Ewallet'],
                        accessCode: 'KAYTOR001',
                        isActive: true
                    },
                    {
                        id: 2,
                        name: 'Neo Selebatso',
                        phone: '+26776781006',
                        email: 'neo@gmail.com',
                        monthlyAmount: 10,
                        relationship: 'Immediate',
                        joinDate: '2026-01-01',
                        paymentMethods: ['Smega', 'Cash'],
                        accessCode: 'NEO002',
                        isActive: true
                    }
                ];
                localStorage.setItem('funeralFundMembers', JSON.stringify(sampleMembers));
            }

            if (!localStorage.getItem('funeralFundPayments')) {
                const samplePayments = [
                    {
                        id: 1,
                        memberId: 1,
                        amount: 10,
                        date: '2024-01-15',
                        method: 'MyZaka',
                        reference: 'TXN001',
                        month: '2024-01',
                        recordedBy: 'admin1',
                        notes: 'January payment'
                    },
                    {
                        id: 2,
                        memberId: 2,
                        amount: 10,
                        date: '2024-01-20',
                        method: 'Smega',
                        reference: 'TXN002',
                        month: '2024-01',
                        recordedBy: 'admin2',
                        notes: 'January payment'
                    }
                ];
                localStorage.setItem('funeralFundPayments', JSON.stringify(samplePayments));
            }

            if (!localStorage.getItem('funeralFundNextId')) {
                localStorage.setItem('funeralFundNextId', '100');
            }

            if (!localStorage.getItem('whatsappLogs')) {
                localStorage.setItem('whatsappLogs', '[]');
            }

            if (!localStorage.getItem('whatsappSettings')) {
                localStorage.setItem('whatsappSettings', JSON.stringify(WHATSAPP_CONFIG));
            }
        }

        // Get Data Functions
        function getMembers() {
            return JSON.parse(localStorage.getItem('funeralFundMembers') || '[]');
        }

        function getPayments() {
            return JSON.parse(localStorage.getItem('funeralFundPayments') || '[]');
        }

        function getNextId() {
            return parseInt(localStorage.getItem('funeralFundNextId') || '100');
        }

        function incrementNextId() {
            const nextId = getNextId() + 1;
            localStorage.setItem('funeralFundNextId', nextId.toString());
            return nextId;
        }

        // Authentication
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const admin = ADMINS.find(a => a.username === username && a.password === password);
            
            if (admin) {
                currentUser = admin;
                isAdmin = true;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appScreen').classList.remove('hidden');
                document.getElementById('currentUserRole').textContent = admin.name;
                showScreen('dashboard');
                updateDashboard();
            } else {
                alert('Invalid username or password');
            }
        }

        function showAdminLogin() {
            document.getElementById('memberAccess').classList.add('hidden');
            document.getElementById('whatsappAccess').classList.add('hidden');
            document.getElementById('adminLogin').classList.remove('hidden');
        }

        function showMemberAccess() {
            document.getElementById('adminLogin').classList.add('hidden');
            document.getElementById('whatsappAccess').classList.add('hidden');
            document.getElementById('memberAccess').classList.remove('hidden');
        }

        function showWhatsAppAccess() {
            document.getElementById('adminLogin').classList.add('hidden');
            document.getElementById('memberAccess').classList.add('hidden');
            document.getElementById('whatsappAccess').classList.remove('hidden');
            generateLoginQRCode();
        }

        function accessAsMember() {
            const code = document.getElementById('memberCode').value.trim().toUpperCase();
            const members = getMembers();
            const member = members.find(m => m.accessCode === code);
            
            if (member) {
                currentMember = member;
                isAdmin = false;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appScreen').classList.remove('hidden');
                document.getElementById('currentUserRole').textContent = 'Family Member';
                
                // Hide admin navigation
                document.querySelectorAll('nav button').forEach(btn => {
                    if (!btn.classList.contains('btn-danger') && btn.id !== 'navWhatsApp') {
                        btn.classList.add('hidden');
                    }
                });
                
                showMemberView();
            } else {
                alert('Invalid access code. Please check the code sent via WhatsApp.');
            }
        }

        function accessViaWhatsApp() {
            const message = `Hello! I'd like to access my NKS & MARY FUND status.`;
            openWhatsAppWithMessage(WHATSAPP_CONFIG.phoneNumber, message);
        }

        function logout() {
            currentUser = null;
            currentMember = null;
            isAdmin = false;
            document.getElementById('appScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            // Reset navigation
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('hidden');
            });
            
            // Reset forms
            showAdminLogin();
        }

        // Navigation
        function showScreen(screenName) {
            // Hide all screens
            document.querySelectorAll('.main-content').forEach(el => {
                el.classList.remove('active-content');
                el.classList.add('hidden');
            });
            
            // Remove active from all nav buttons
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected screen
            const screen = document.getElementById(screenName + 'Screen');
            if (screen) {
                screen.classList.remove('hidden');
                screen.classList.add('active-content');
                
                // Update active nav button
                const navBtn = document.getElementById('nav' + screenName.charAt(0).toUpperCase() + screenName.slice(1));
                if (navBtn) {
                    navBtn.classList.add('active');
                }
            }
            
            // Update data for screen
            switch(screenName) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'members':
                    loadMembersTable();
                    break;
                case 'payments':
                    loadPaymentsTable();
                    break;
                case 'reports':
                    loadReports();
                    break;
                case 'whatsapp':
                    loadWhatsAppHistory();
                    break;
            }
        }

        function showMemberView() {
            // Hide all screens
            document.querySelectorAll('.main-content').forEach(el => {
                el.classList.remove('active-content');
                el.classList.add('hidden');
            });
            
            // Show member view
            const screen = document.getElementById('memberViewScreen');
            screen.classList.remove('hidden');
            screen.classList.add('active-content');
            
            updateMemberView();
        }

        // Dashboard Functions
        function updateDashboard() {
            const members = getMembers();
            const payments = getPayments();
            const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
            
            // Update stats
            document.getElementById('totalMembers').textContent = members.length;
            
            const totalBalance = payments.reduce((sum, p) => sum + p.amount, 0);
            document.getElementById('totalBalance').textContent = 'P' + totalBalance;
            
            const paidThisMonth = payments.filter(p => p.month === currentMonth).length;
            document.getElementById('paidThisMonth').textContent = paidThisMonth;
            
            const unpaidThisMonth = members.length - paidThisMonth;
            document.getElementById('unpaidThisMonth').textContent = unpaidThisMonth;
            
            // Update current month display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const currentDate = new Date();
            const monthName = monthNames[currentDate.getMonth()] + ' ' + currentDate.getFullYear();
            document.getElementById('currentMonth').textContent = monthName;
            
            // Update dashboard table
            updateDashboardTable();
            updateRecentPayments();
            updateUnpaidMembers();
        }

        function updateDashboardTable() {
            const members = getMembers();
            const payments = getPayments();
            const currentMonth = new Date().toISOString().slice(0, 7);
            const tbody = document.getElementById('dashboardTableBody');
            tbody.innerHTML = '';
            
            members.forEach(member => {
                const memberPayments = payments.filter(p => 
                    p.memberId === member.id && p.month === currentMonth
                );
                const totalPaid = memberPayments.reduce((sum, p) => sum + p.amount, 0);
                const status = totalPaid >= member.monthlyAmount ? 'Paid' : 
                              totalPaid > 0 ? 'Partial' : 'Unpaid';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${member.name}</td>
                    <td>P${member.monthlyAmount}</td>
                    <td>P${totalPaid}</td>
                    <td class="${status.toLowerCase()}">${status}</td>
                    <td>P${member.monthlyAmount - totalPaid}</td>
                    <td>
                        <button onclick="sendDirectMessage(${member.id})" class="btn btn-sm whatsapp-btn">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateRecentPayments() {
            const payments = getPayments();
            const members = getMembers();
            const tbody = document.getElementById('recentPaymentsBody');
            tbody.innerHTML = '';
            
            // Show last 10 payments
            const recentPayments = payments.slice(-10).reverse();
            
            recentPayments.forEach(payment => {
                const member = members.find(m => m.id === payment.memberId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${payment.date}</td>
                    <td>${member ? member.name : 'Unknown'}</td>
                    <td>P${payment.amount}</td>
                    <td>${payment.method}</td>
                    <td>${payment.month}</td>
                    <td>
                        <button onclick="sendPaymentMessage(${payment.memberId}, ${payment.amount})" class="btn btn-sm whatsapp-btn">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateUnpaidMembers() {
            const members = getMembers();
            const payments = getPayments();
            const currentMonth = new Date().toISOString().slice(0, 7);
            const tbody = document.getElementById('unpaidMembersBody');
            tbody.innerHTML = '';
            
            members.forEach(member => {
                const memberPayments = payments.filter(p => 
                    p.memberId === member.id && p.month === currentMonth
                );
                const totalPaid = memberPayments.reduce((sum, p) => sum + p.amount, 0);
                
                if (totalPaid < member.monthlyAmount) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${member.name}</td>
                        <td>${member.phone}</td>
                        <td>P${member.monthlyAmount}</td>
                        <td>
                            <button onclick="sendDirectMessage(${member.id})" class="btn btn-sm whatsapp-btn">
                                <i class="fab fa-whatsapp"></i> Remind
                            </button>
                        </td>
                        <td>
                            <button onclick="recordPaymentForMember(${member.id})" class="btn btn-primary">
                                <i class="fas fa-money-bill"></i> Record Payment
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            });
        }

        function showDashboardTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.dashboard-tab').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active from all tab buttons
            document.querySelectorAll('#dashboardScreen .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            const tab = document.getElementById('dashboard' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            if (tab) {
                tab.classList.remove('hidden');
            }
            
            // Update active tab button
            const tabButtons = document.querySelectorAll('#dashboardScreen .tab');
            tabButtons.forEach(button => {
                if (button.textContent.toLowerCase().includes(tabName.toLowerCase())) {
                    button.classList.add('active');
                }
            });
        }

        // Members Management
        function showAddMemberForm() {
            document.getElementById('addMemberForm').classList.remove('hidden');
            document.getElementById('editMemberForm').classList.add('hidden');
        }

        function hideAddMemberForm() {
            document.getElementById('addMemberForm').classList.add('hidden');
        }

        function addNewMember() {
            const name = document.getElementById('newMemberName').value;
            const phone = document.getElementById('newMemberPhone').value;
            const email = document.getElementById('newMemberEmail').value;
            const monthly = parseFloat(document.getElementById('newMemberMonthly').value);
            const relationship = document.getElementById('newMemberRelationship').value;
            
            const paymentMethodCheckboxes = document.querySelectorAll('input[name="paymentMethod"]:checked');
            const paymentMethods = Array.from(paymentMethodCheckboxes).map(cb => cb.value);
            
            if (!name || !phone || !monthly) {
                alert('Please fill in all required fields');
                return;
            }
            
            const members = getMembers();
            const newMember = {
                id: incrementNextId(),
                name: name,
                phone: phone,
                email: email || '',
                monthlyAmount: monthly,
                relationship: relationship,
                joinDate: new Date().toISOString().slice(0, 10),
                paymentMethods: paymentMethods,
                accessCode: generateAccessCode(name),
                isActive: true
            };
            
            members.push(newMember);
            localStorage.setItem('funeralFundMembers', JSON.stringify(members));
            
            // Send welcome message via WhatsApp
            const message = WHATSAPP_CONFIG.templates.welcome
                .replace(/{name}/g, name)
                .replace(/{amount}/g, monthly)
                .replace(/{code}/g, newMember.accessCode)
                .replace(/{business}/g, WHATSAPP_CONFIG.businessName)
                .replace(/{link}/g, window.location.href.split('#')[0])
                .replace(/{adminPhone}/g, WHATSAPP_CONFIG.phoneNumber);
            
            openWhatsAppWithMessage(phone, message);
            
            // Clear form
            document.getElementById('newMemberName').value = '';
            document.getElementById('newMemberPhone').value = '';
            document.getElementById('newMemberEmail').value = '';
            document.getElementById('newMemberMonthly').value = '50';
            
            alert('Member added successfully! Access code: ' + newMember.accessCode + '\nWhatsApp welcome message sent.');
            hideAddMemberForm();
            loadMembersTable();
            updateDashboard();
        }

        function generateAccessCode(name) {
            const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();
            const randomNum = Math.floor(1000 + Math.random() * 9000);
            return initials + randomNum;
        }

        function loadMembersTable() {
            const members = getMembers();
            const tbody = document.getElementById('membersTableBody');
            tbody.innerHTML = '';
            
            members.forEach(member => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${member.name}</td>
                    <td>${member.phone}</td>
                    <td>P${member.monthlyAmount}</td>
                    <td>${member.paymentMethods.join(', ')}</td>
                    <td>${member.joinDate}</td>
                    <td>${member.isActive ? 'Active' : 'Inactive'}</td>
                    <td>
                        <button onclick="sendDirectMessage(${member.id})" class="btn btn-sm whatsapp-btn">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                    </td>
                    <td>
                        <button onclick="editMember(${member.id})" class="btn btn-primary">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteMember(${member.id})" class="btn btn-danger">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function editMember(memberId) {
            const members = getMembers();
            const member = members.find(m => m.id === memberId);
            
            if (!member) return;
            
            let editForm = document.getElementById('editMemberForm');
            editForm.innerHTML = `
                <h3>Edit Member: ${member.name}</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editMemberName">Full Name</label>
                        <input type="text" id="editMemberName" value="${member.name}">
                    </div>
                    <div class="form-group">
                        <label for="editMemberPhone">Phone Number</label>
                        <input type="tel" id="editMemberPhone" value="${member.phone}">
                    </div>
                    <div class="form-group">
                        <label for="editMemberEmail">Email</label>
                        <input type="email" id="editMemberEmail" value="${member.email}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editMemberMonthly">Monthly Contribution</label>
                        <input type="number" id="editMemberMonthly" value="${member.monthlyAmount}">
                    </div>
                    <div class="form-group">
                        <label for="editMemberRelationship">Relationship</label>
                        <select id="editMemberRelationship">
                            <option value="Immediate" ${member.relationship === 'Immediate' ? 'selected' : ''}>Immediate Family</option>
                            <option value="Extended" ${member.relationship === 'Extended' ? 'selected' : ''}>Extended Family</option>
                            <option value="Friend" ${member.relationship === 'Friend' ? 'selected' : ''}>Family Friend</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <div>
                            <label><input type="radio" name="editMemberStatus" value="active" ${member.isActive ? 'checked' : ''}> Active</label>
                            <label><input type="radio" name="editMemberStatus" value="inactive" ${!member.isActive ? 'checked' : ''}> Inactive</label>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <button onclick="updateMember(${member.id})" class="btn btn-success">
                        <i class="fas fa-save"></i> Update
                    </button>
                    <button onclick="cancelEdit()" class="btn btn-danger">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            `;
            
            editForm.classList.remove('hidden');
            document.getElementById('addMemberForm').classList.add('hidden');
        }

        function updateMember(memberId) {
            const members = getMembers();
            const memberIndex = members.findIndex(m => m.id === memberId);
            
            if (memberIndex === -1) return;
            
            members[memberIndex].name = document.getElementById('editMemberName').value;
            members[memberIndex].phone = document.getElementById('editMemberPhone').value;
            members[memberIndex].email = document.getElementById('editMemberEmail').value;
            members[memberIndex].monthlyAmount = parseFloat(document.getElementById('editMemberMonthly').value);
            members[memberIndex].relationship = document.getElementById('editMemberRelationship').value;
            members[memberIndex].isActive = document.querySelector('input[name="editMemberStatus"]:checked').value === 'active';
            
            localStorage.setItem('funeralFundMembers', JSON.stringify(members));
            document.getElementById('editMemberForm').classList.add('hidden');
            loadMembersTable();
            updateDashboard();
        }

        function cancelEdit() {
            document.getElementById('editMemberForm').classList.add('hidden');
        }

        function deleteMember(memberId) {
            if (confirm('Are you sure you want to delete this member? This action cannot be undone.')) {
                let members = getMembers();
                members = members.filter(m => m.id !== memberId);
                localStorage.setItem('funeralFundMembers', JSON.stringify(members));
                loadMembersTable();
                updateDashboard();
            }
        }

        // Payments Management
        function showRecordPaymentForm() {
            // Populate member dropdown
            const memberSelect = document.getElementById('paymentMember');
            memberSelect.innerHTML = '<option value="">Select Member</option>';
            
            const members = getMembers();
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = `${member.name} (P${member.monthlyAmount}/month)`;
                memberSelect.appendChild(option);
            });
            
            // Populate month dropdown
            const monthSelect = document.getElementById('paymentMonth');
            monthSelect.innerHTML = '';
            
            const currentDate = new Date();
            for (let i = -6; i <= 6; i++) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() + i, 1);
                const monthValue = date.toISOString().slice(0, 7);
                const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                const option = document.createElement('option');
                option.value = monthValue;
                option.textContent = monthName;
                option.selected = i === 0;
                monthSelect.appendChild(option);
            }
            
            // Set default date to today
            document.getElementById('paymentDate').valueAsDate = new Date();
            
            document.getElementById('recordPaymentForm').classList.remove('hidden');
            document.getElementById('whatsappConfirmation').classList.add('hidden');
        }

        function hideRecordPaymentForm() {
            document.getElementById('recordPaymentForm').classList.add('hidden');
        }

        function recordPayment() {
            const memberId = parseInt(document.getElementById('paymentMember').value);
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const date = document.getElementById('paymentDate').value;
            const method = document.getElementById('paymentMethod').value;
            const reference = document.getElementById('paymentReference').value;
            const month = document.getElementById('paymentMonth').value;
            const notes = document.getElementById('paymentNotes').value;
            
            if (!memberId || !amount || !date || !method || !month) {
                alert('Please fill in all required fields');
                return;
            }
            
            const payments = getPayments();
            const newPayment = {
                id: incrementNextId(),
                memberId: memberId,
                amount: amount,
                date: date,
                method: method,
                reference: reference || '',
                month: month,
                recordedBy: currentUser.username,
                notes: notes || '',
                timestamp: new Date().toISOString()
            };
            
            payments.push(newPayment);
            localStorage.setItem('funeralFundPayments', JSON.stringify(payments));
            
            // Generate WhatsApp confirmation message
            const member = getMembers().find(m => m.id === memberId);
            if (member) {
                const currentMonth = new Date().toISOString().slice(0, 7);
                const monthPayments = payments.filter(p => p.memberId === memberId && p.month === currentMonth);
                const totalPaid = monthPayments.reduce((sum, p) => sum + p.amount, 0);
                const balance = member.monthlyAmount - totalPaid;
                
                const confirmationMsg = WHATSAPP_CONFIG.templates.payment_thanks
                    .replace(/{firstName}/g, member.name.split(' ')[0])
                    .replace(/{paidAmount}/g, amount)
                    .replace(/{month}/g, getCurrentMonthName())
                    .replace(/{balance}/g, balance)
                    .replace(/{code}/g, member.accessCode)
                    .replace(/{business}/g, WHATSAPP_CONFIG.businessName)
                    .replace(/{link}/g, window.location.href.split('#')[0]);
                
                document.getElementById('whatsappConfirmationMsg').value = confirmationMsg;
                document.getElementById('whatsappConfirmation').classList.remove('hidden');
            }
            
            alert('Payment recorded successfully!');
            loadPaymentsTable();
            updateDashboard();
            
            // Clear form except confirmation
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentReference').value = '';
            document.getElementById('paymentNotes').value = '';
        }

        function sendPaymentConfirmation() {
            const memberId = parseInt(document.getElementById('paymentMember').value);
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const member = getMembers().find(m => m.id === memberId);
            
            if (!member) {
                alert('Member not found');
                return;
            }
            
            sendPaymentConfirmationViaWhatsApp(memberId, amount);
            alert('WhatsApp confirmation sent!');
            hideRecordPaymentForm();
        }

        function recordPaymentForMember(memberId) {
            showRecordPaymentForm();
            document.getElementById('paymentMember').value = memberId;
            document.getElementById('paymentAmount').focus();
        }

        function loadPaymentsTable() {
            const payments = getPayments();
            const members = getMembers();
            
            // Populate filter dropdowns
            populateMonthFilter();
            populateMemberFilter();
            
            // Display all payments by default
            displayFilteredPayments(payments);
        }

        function populateMonthFilter() {
            const monthSelect = document.getElementById('filterMonth');
            monthSelect.innerHTML = '<option value="all">All Months</option>';
            
            const payments = getPayments();
            const uniqueMonths = [...new Set(payments.map(p => p.month))].sort().reverse();
            
            uniqueMonths.forEach(month => {
                const date = new Date(month + '-01');
                const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                const option = document.createElement('option');
                option.value = month;
                option.textContent = monthName;
                monthSelect.appendChild(option);
            });
        }

        function populateMemberFilter() {
            const memberSelect = document.getElementById('filterMember');
            memberSelect.innerHTML = '<option value="all">All Members</option>';
            
            const members = getMembers();
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                memberSelect.appendChild(option);
            });
        }

        function filterPayments() {
            const monthFilter = document.getElementById('filterMonth').value;
            const memberFilter = document.getElementById('filterMember').value;
            
            let payments = getPayments();
            
            if (monthFilter !== 'all') {
                payments = payments.filter(p => p.month === monthFilter);
            }
            
            if (memberFilter !== 'all') {
                const memberId = parseInt(memberFilter);
                payments = payments.filter(p => p.memberId === memberId);
            }
            
            displayFilteredPayments(payments);
        }

        function displayFilteredPayments(payments) {
            const members = getMembers();
            const tbody = document.getElementById('paymentsTableBody');
            tbody.innerHTML = '';
            
            // Sort by date (newest first)
            payments.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            payments.forEach(payment => {
                const member = members.find(m => m.id === payment.memberId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${payment.date}</td>
                    <td>${member ? member.name : 'Unknown'}</td>
                    <td>P${payment.amount}</td>
                    <td>${payment.method}</td>
                    <td>${payment.reference || '-'}</td>
                    <td>${payment.month}</td>
                    <td>${payment.recordedBy}</td>
                    <td>
                        <button onclick="sendPaymentMessage(${payment.memberId}, ${payment.amount})" class="btn btn-sm whatsapp-btn">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                    </td>
                    <td>
                        <button onclick="deletePayment(${payment.id})" class="btn btn-danger">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function deletePayment(paymentId) {
            if (confirm('Are you sure you want to delete this payment record?')) {
                let payments = getPayments();
                payments = payments.filter(p => p.id !== paymentId);
                localStorage.setItem('funeralFundPayments', JSON.stringify(payments));
                loadPaymentsTable();
                updateDashboard();
            }
        }

        // Reports Functions
        function loadReports() {
            populateReportMonthFilter();
            populateMemberStatsFilter();
            loadMonthlyReport();
        }

        function populateReportMonthFilter() {
            const monthSelect = document.getElementById('reportMonth');
            monthSelect.innerHTML = '';
            
            const payments = getPayments();
            const uniqueMonths = [...new Set(payments.map(p => p.month))].sort().reverse();
            
            uniqueMonths.forEach(month => {
                const date = new Date(month + '-01');
                const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                const option = document.createElement('option');
                option.value = month;
                option.textContent = monthName;
                if (month === new Date().toISOString().slice(0, 7)) {
                    option.selected = true;
                }
                monthSelect.appendChild(option);
            });
        }

        function populateMemberStatsFilter() {
            const memberSelect = document.getElementById('selectMemberStats');
            memberSelect.innerHTML = '<option value="">Select Member</option>';
            
            const members = getMembers();
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                memberSelect.appendChild(option);
            });
        }

        function loadMonthlyReport() {
            const month = document.getElementById('reportMonth').value;
            if (!month) return;
            
            const members = getMembers();
            const payments = getPayments();
            const monthPayments = payments.filter(p => p.month === month);
            
            // Update title
            const date = new Date(month + '-01');
            const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            document.getElementById('selectedMonthTitle').textContent = `Report for ${monthName}`;
            
            // Calculate statistics
            const totalMembers = members.length;
            const totalCollected = monthPayments.reduce((sum, p) => sum + p.amount, 0);
            const expectedAmount = members.reduce((sum, m) => sum + m.monthlyAmount, 0);
            const collectionRate = expectedAmount > 0 ? Math.round((totalCollected / expectedAmount) * 100) : 0;
            
            // Update stats cards
            document.getElementById('reportTotalMembers').textContent = totalMembers;
            document.getElementById('reportTotalCollected').textContent = 'P' + totalCollected;
            document.getElementById('reportExpectedAmount').textContent = 'P' + expectedAmount;
            document.getElementById('reportCollectionRate').textContent = collectionRate + '%';
            
            // Update detailed table
            const tbody = document.getElementById('monthlyReportBody');
            tbody.innerHTML = '';
            
            members.forEach(member => {
                const memberPayments = monthPayments.filter(p => p.memberId === member.id);
                const totalPaid = memberPayments.reduce((sum, p) => sum + p.amount, 0);
                const balance = member.monthlyAmount - totalPaid;
                const status = totalPaid >= member.monthlyAmount ? 'Paid' : 
                              totalPaid > 0 ? 'Partial' : 'Unpaid';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${member.name}</td>
                    <td>P${member.monthlyAmount}</td>
                    <td>P${totalPaid}</td>
                    <td>P${balance}</td>
                    <td class="${status.toLowerCase()}">${status}</td>
                    <td>
                        <button onclick="sendDirectMessage(${member.id})" class="btn btn-sm whatsapp-btn">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadMemberStats() {
            const memberId = parseInt(document.getElementById('selectMemberStats').value);
            if (!memberId) return;
            
            const members = getMembers();
            const payments = getPayments();
            const member = members.find(m => m.id === memberId);
            
            if (!member) return;
            
            document.getElementById('memberStatsName').textContent = `Statistics for ${member.name}`;
            
            // Calculate member statistics
            const memberPayments = payments.filter(p => p.memberId === memberId);
            const totalPaid = memberPayments.reduce((sum, p) => sum + p.amount, 0);
            
            const uniqueMonthsPaid = [...new Set(memberPayments.map(p => p.month))].length;
            const currentMonth = new Date().toISOString().slice(0, 7);
            const currentMonthPayments = memberPayments.filter(p => p.month === currentMonth);
            const currentMonthPaid = currentMonthPayments.reduce((sum, p) => sum + p.amount, 0);
            const currentBalance = member.monthlyAmount - currentMonthPaid;
            
            const joinDate = new Date(member.joinDate);
            const currentDate = new Date();
            const monthsSinceJoin = (currentDate.getFullYear() - joinDate.getFullYear()) * 12 + 
                                   (currentDate.getMonth() - joinDate.getMonth());
            const expectedTotal = Math.max(0, monthsSinceJoin) * member.monthlyAmount;
            const paymentRate = expectedTotal > 0 ? Math.round((totalPaid / expectedTotal) * 100) : 0;
            
            // Update stats cards
            document.getElementById('memberTotalPaid').textContent = 'P' + totalPaid;
            document.getElementById('memberMonthsPaid').textContent = uniqueMonthsPaid;
            document.getElementById('memberCurrentBalance').textContent = 'P' + currentBalance;
            document.getElementById('memberPaymentRate').textContent = paymentRate + '%';
            
            // Update payment history
            const tbody = document.getElementById('memberHistoryBody');
            tbody.innerHTML = '';
            
            // Group payments by month
            const paymentsByMonth = {};
            memberPayments.forEach(payment => {
                if (!paymentsByMonth[payment.month]) {
                    paymentsByMonth[payment.month] = [];
                }
                paymentsByMonth[payment.month].push(payment);
            });
            
            // Sort months in reverse chronological order
            const months = Object.keys(paymentsByMonth).sort().reverse();
            
            months.forEach(month => {
                const monthPayments = paymentsByMonth[month];
                const monthTotal = monthPayments.reduce((sum, p) => sum + p.amount, 0);
                const date = new Date(month + '-01');
                const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                const status = monthTotal >= member.monthlyAmount ? 'Paid' : 
                              monthTotal > 0 ? 'Partial' : 'Unpaid';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${monthName}</td>
                    <td>P${monthTotal}</td>
                    <td>${monthPayments[0].method}</td>
                    <td>${monthPayments[0].date}</td>
                    <td class="${status.toLowerCase()}">${status}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function showReportTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.report-tab').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active from all tab buttons
            document.querySelectorAll('#reportsScreen .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            const tab = document.getElementById(tabName + 'Report');
            if (tab) {
                tab.classList.remove('hidden');
            }
            
            // Update active tab button
            const tabButtons = document.querySelectorAll('#reportsScreen .tab');
            tabButtons.forEach(button => {
                if (button.textContent.toLowerCase().includes(tabName.toLowerCase())) {
                    button.classList.add('active');
                }
            });
            
            // Load specific tab data
            if (tabName === 'paymentMethods') {
                loadPaymentMethodsReport();
            }
        }

        function loadPaymentMethodsReport() {
            const payments = getPayments();
            
            // Group by payment method
            const methodStats = {};
            payments.forEach(payment => {
                if (!methodStats[payment.method]) {
                    methodStats[payment.method] = { count: 0, total: 0 };
                }
                methodStats[payment.method].count++;
                methodStats[payment.method].total += payment.amount;
            });
            
            const totalTransactions = payments.length;
            const totalAmount = payments.reduce((sum, p) => sum + p.amount, 0);
            
            // Update table
            const tbody = document.getElementById('paymentMethodsBody');
            tbody.innerHTML = '';
            
            Object.keys(methodStats).sort().forEach(method => {
                const stats = methodStats[method];
                const percentage = totalTransactions > 0 ? 
                    Math.round((stats.count / totalTransactions) * 100) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${method}</td>
                    <td>${stats.count}</td>
                    <td>P${stats.total}</td>
                    <td>${percentage}%</td>
                `;
                tbody.appendChild(row);
            });
            
            // Create chart
            createPaymentMethodsChart(methodStats);
        }

        function createPaymentMethodsChart(methodStats) {
            const ctx = document.getElementById('methodsChart');
            if (!ctx) return;
            
            // Clear previous chart
            ctx.width = ctx.width;
            
            const labels = Object.keys(methodStats);
            const data = labels.map(label => methodStats[label].count);
            const backgroundColors = [
                '#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6',
                '#1abc9c', '#d35400', '#34495e', '#7f8c8d', '#16a085'
            ];
            
            new Chart(ctx.getContext('2d'), {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Payment Methods Distribution'
                        }
                    }
                }
            });
        }

        function generateMonthlyReport() {
            const month = document.getElementById('reportMonth').value;
            if (!month) return;
            
            const members = getMembers();
            const payments = getPayments();
            const monthPayments = payments.filter(p => p.month === month);
            
            // Create report content
            const date = new Date(month + '-01');
            const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            let reportContent = `
                üè¶NKS & MARY FUND - MONTHLY REPORT
                ====================================
                Month: ${monthName}
                Generated: ${new Date().toLocaleDateString()}
                
                SUMMARY:
                ---------
                Total Members: ${members.length}
                Expected Amount: P${members.reduce((sum, m) => sum + m.monthlyAmount, 0)}
                Total Collected: P${monthPayments.reduce((sum, p) => sum + p.amount, 0)}
                Collection Rate: ${members.length > 0 ? Math.round((monthPayments.reduce((sum, p) => sum + p.amount, 0) / members.reduce((sum, m) => sum + m.monthlyAmount, 0)) * 100) : 0}%
                
                DETAILED STATUS:
                ----------------
            `;
            
            members.forEach(member => {
                const memberPayments = monthPayments.filter(p => p.memberId === member.id);
                const totalPaid = memberPayments.reduce((sum, p) => sum + p.amount, 0);
                const status = totalPaid >= member.monthlyAmount ? 'PAID' : 
                              totalPaid > 0 ? 'PARTIAL' : 'UNPAID';
                
                reportContent += `
                ${member.name}
                  Monthly Target: P${member.monthlyAmount}
                  Amount Paid: P${totalPaid}
                  Balance: P${member.monthlyAmount - totalPaid}
                  Status: ${status}
                `;
            });
            
            reportContent += `
                PAYMENT DETAILS:
                ---------------
            `;
            
            monthPayments.forEach(payment => {
                const member = members.find(m => m.id === payment.memberId);
                reportContent += `
                ${payment.date} - ${member ? member.name : 'Unknown'} - P${payment.amount} (${payment.method}) - Ref: ${payment.reference || 'N/A'}
                `;
            });
            
            // Create downloadable file
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Funeral_Fund_Report_${month}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Report generated and downloaded!');
        }

        // Member View Functions
        function updateMemberView() {
            if (!currentMember) return;
            
            const members = getMembers();
            const payments = getPayments();
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            // Update member info
            document.getElementById('memberViewName').textContent = currentMember.name;
            
            // Calculate member statistics
            const memberPayments = payments.filter(p => p.memberId === currentMember.id);
            const totalPaid = memberPayments.reduce((sum, p) => sum + p.amount, 0);
            
            const currentMonthPayments = memberPayments.filter(p => p.month === currentMonth);
            const currentMonthPaid = currentMonthPayments.reduce((sum, p) => sum + p.amount, 0);
            const currentStatus = currentMonthPaid >= currentMember.monthlyAmount ? 'Paid' :
                                 currentMonthPaid > 0 ? 'Partial' : 'Unpaid';
            
            const fundBalance = payments.reduce((sum, p) => sum + p.amount, 0);
            
            // Update stats
            document.getElementById('memberPersonalPaid').textContent = 'P' + totalPaid;
            document.getElementById('memberCurrentStatus').textContent = currentStatus;
            document.getElementById('memberCurrentStatus').className = currentStatus.toLowerCase();
            document.getElementById('memberMonthlyAmount').textContent = 'P' + currentMember.monthlyAmount;
            document.getElementById('memberViewBalance').textContent = 'P' + fundBalance;
            
            // Generate personal QR code
            generateMemberQRCode();
            
            // Update personal payment history
            const personalHistoryBody = document.getElementById('memberPersonalHistory');
            personalHistoryBody.innerHTML = '';
            
            // Group payments by month
            const paymentsByMonth = {};
            memberPayments.forEach(payment => {
                if (!paymentsByMonth[payment.month]) {
                    paymentsByMonth[payment.month] = [];
                }
                paymentsByMonth[payment.month].push(payment);
            });
            
            // Sort months in reverse chronological order
            const months = Object.keys(paymentsByMonth).sort().reverse();
            
            months.forEach(month => {
                const monthPayments = paymentsByMonth[month];
                const monthTotal = monthPayments.reduce((sum, p) => sum + p.amount, 0);
                const date = new Date(month + '-01');
                const monthName = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                const status = monthTotal >= currentMember.monthlyAmount ? 'Paid' : 
                              monthTotal > 0 ? 'Partial' : 'Unpaid';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${monthName}</td>
                    <td>P${monthTotal}</td>
                    <td>${monthPayments[0].method}</td>
                    <td>${monthPayments[0].date}</td>
                    <td class="${status.toLowerCase()}">${status}</td>
                `;
                personalHistoryBody.appendChild(row);
            });
            
            // Update family status table
            const familyStatusBody = document.getElementById('familyStatusTable');
            familyStatusBody.innerHTML = '';
            
            members.forEach(member => {
                const memberPayments = payments.filter(p => 
                    p.memberId === member.id && p.month === currentMonth
                );
                const totalPaid = memberPayments.reduce((sum, p) => sum + p.amount, 0);
                const status = totalPaid >= member.monthlyAmount ? 'Paid' : 
                              totalPaid > 0 ? 'Partial' : 'Unpaid';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${member.name} ${member.id === currentMember.id ? '(You)' : ''}</td>
                    <td>P${member.monthlyAmount}</td>
                    <td>P${totalPaid}</td>
                    <td class="${status.toLowerCase()}">${status}</td>
                `;
                familyStatusBody.appendChild(row);
            });
        }

        // WhatsApp Integration Functions
        function generateLoginQRCode() {
            const qrContainer = document.getElementById('qrcode');
            if (!qrContainer) return;
            
            qrContainer.innerHTML = '';
            const appUrl = window.location.href.split('#')[0];
            const qrText = `${WHATSAPP_CONFIG.businessName}\nAccess Fund Status\n${appUrl}`;
            
            QRCode.toCanvas(qrContainer, qrText, {
                width: 200,
                margin: 1,
                color: {
                    dark: '#25D366',
                    light: '#FFFFFF'
                }
            });
        }

        function generateMemberQRCode() {
            if (!currentMember) return;
            
            const qrContainer = document.getElementById('memberQRCode');
            if (!qrContainer) return;
            
            qrContainer.innerHTML = '';
            const memberUrl = `${window.location.href.split('#')[0]}?code=${currentMember.accessCode}`;
            const qrText = `${WHATSAPP_CONFIG.businessName}\n${currentMember.name}'s Status\n${memberUrl}`;
            
            QRCode.toCanvas(qrContainer, qrText, {
                width: 150,
                margin: 1,
                color: {
                    dark: '#25D366',
                    light: '#FFFFFF'
                }
            });
        }

        function sendWhatsAppLink() {
            const phone = document.getElementById('whatsappNumber').value;
            if (!phone || phone.length < 10) {
                alert('Please enter a valid WhatsApp number');
                return;
            }
            
            const appUrl = window.location.href.split('#')[0];
            const message = `üè¶ ${WHATSAPP_CONFIG.businessName}\n\nAccess your contribution status:\n${appUrl}\n\nSave this link for future access!`;
            
            openWhatsAppWithMessage(phone, message);
        }

        // Core WhatsApp Functions
        function openWhatsAppWithMessage(phone, message) {
            const cleanPhone = phone.replace(/[\s\+]/g, '');
            const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function shareMyStatus() {
            if (!currentMember) return;
            
            const status = getMemberCurrentStatus(currentMember.id);
            const message = WHATSAPP_CONFIG.templates.payment_reminder
                .replace(/{firstName}/g, currentMember.name.split(' ')[0])
                .replace(/{amount}/g, currentMember.monthlyAmount)
                .replace(/{month}/g, getCurrentMonthName())
                .replace(/{code}/g, currentMember.accessCode)
                .replace(/{business}/g, WHATSAPP_CONFIG.businessName)
                .replace(/{link}/g, window.location.href.split('#')[0])
                .replace(/{adminPhone}/g, WHATSAPP_CONFIG.phoneNumber)
                .replace(/{paidAmount}/g, status.paid)
                .replace(/{balance}/g, status.balance);
            
            openWhatsAppWithMessage(currentMember.phone, message);
        }

        function sendWhatsAppRemindersToAll() {
            if (!confirm(`Send WhatsApp reminders to ALL members?`)) return;
            
            const members = getMembers();
            const unpaidMembers = getUnpaidMembers();
            
            let count = 0;
            unpaidMembers.forEach(member => {
                setTimeout(() => {
                    sendWhatsAppReminder(member);
                }, count * 2000); // 2 second delay between messages
                count++;
            });
            
            alert(`Opening WhatsApp for ${count} members. Please send each message.`);
        }

        function sendWhatsAppReminder(member) {
            const status = getMemberCurrentStatus(member.id);
            const message = WHATSAPP_CONFIG.templates.payment_reminder
                .replace(/{firstName}/g, member.name.split(' ')[0])
                .replace(/{amount}/g, member.monthlyAmount)
                .replace(/{month}/g, getCurrentMonthName())
                .replace(/{code}/g, member.accessCode)
                .replace(/{business}/g, WHATSAPP_CONFIG.businessName)
                .replace(/{link}/g, window.location.href.split('#')[0])
                .replace(/{adminPhone}/g, WHATSAPP_CONFIG.phoneNumber)
                .replace(/{paidAmount}/g, status.paid)
                .replace(/{balance}/g, status.balance);
            
            openWhatsAppWithMessage(member.phone, message);
            logWhatsAppMessage(member.id, 'reminder', message);
        }

        function sendPaymentConfirmationViaWhatsApp(memberId, paymentAmount) {
            const member = getMembers().find(m => m.id === memberId);
            if (!member) return;
            
            const status = getMemberCurrentStatus(memberId);
            const message = WHATSAPP_CONFIG.templates.payment_thanks
                .replace(/{firstName}/g, member.name.split(' ')[0])
                .replace(/{paidAmount}/g, paymentAmount)
                .replace(/{month}/g, getCurrentMonthName())
                .replace(/{balance}/g, status.balance)
                .replace(/{code}/g, member.accessCode)
                .replace(/{business}/g, WHATSAPP_CONFIG.businessName)
                .replace(/{link}/g, window.location.href.split('#')[0]);
            
            openWhatsAppWithMessage(member.phone, message);
            logWhatsAppMessage(memberId, 'confirmation', message);
        }

        function sendDirectMessage(memberId) {
            const member = getMembers().find(m => m.id === memberId);
            if (!member) return;
            
            const status = getMemberCurrentStatus(memberId);
            const message = `üè¶ ${WHATSAPP_CONFIG.businessName}\n\nHello ${member.name.split(' ')[0]},\n\nYour current status:\nMonthly: P${member.monthlyAmount}\nPaid: P${status.paid}\nBalance: P${status.balance}\nStatus: ${status.status}\n\nCode: ${member.accessCode}`;
            
            openWhatsAppWithMessage(member.phone, message);
        }

        function sendPaymentMessage(memberId, amount) {
            const member = getMembers().find(m => m.id === memberId);
            if (!member) return;
            
            const message = `‚úÖ ${WHATSAPP_CONFIG.businessName} Payment\n\nThank you ${member.name.split(' ')[0]}!\nPayment of P${amount} received.\n\nCode: ${member.accessCode}\nView: ${window.location.href.split('#')[0]}`;
            
            openWhatsAppWithMessage(member.phone, message);
        }

        // Broadcast System
        function loadBroadcastTemplate() {
            const template = document.getElementById('broadcastTemplate').value;
            if (template === 'custom') return;
            
            const message = WHATSAPP_CONFIG.templates[template]
                .replace(/{business}/g, WHATSAPP_CONFIG.businessName)
                .replace(/{month}/g, getCurrentMonthName())
                .replace(/{adminPhone}/g, WHATSAPP_CONFIG.phoneNumber);
            
            document.getElementById('broadcastMessage').value = message;
        }

        function sendBroadcast() {
            const message = document.getElementById('broadcastMessage').value;
            const recipientType = document.getElementById('broadcastRecipients').value;
            
            if (!message.trim()) {
                alert('Please enter a message');
                return;
            }
            
            const members = getFilteredMembers(recipientType);
            
            if (members.length === 0) {
                alert('No members match the selected filter');
                return;
            }
            
            if (!confirm(`Send message to ${members.length} members?`)) return;
            
            members.forEach((member, index) => {
                setTimeout(() => {
                    const personalizedMessage = personalizeMessage(message, member);
                    openWhatsAppWithMessage(member.phone, personalizedMessage);
                    logWhatsAppMessage(member.id, 'broadcast', personalizedMessage);
                }, index * 3000); // 3 second delay
            });
            
            alert(`Opening ${members.length} WhatsApp windows. Send each message.`);
        }

        function getFilteredMembers(filter) {
            const allMembers = getMembers();
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            switch(filter) {
                case 'unpaid':
                    return allMembers.filter(member => {
                        const payments = getPayments().filter(p => 
                            p.memberId === member.id && p.month === currentMonth
                        );
                        const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
                        return totalPaid < member.monthlyAmount;
                    });
                    
                case 'paid':
                    return allMembers.filter(member => {
                        const payments = getPayments().filter(p => 
                            p.memberId === member.id && p.month === currentMonth
                        );
                        const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
                        return totalPaid >= member.monthlyAmount;
                    });
                    
                case 'immediate':
                    return allMembers.filter(m => m.relationship === 'Immediate');
                    
                case 'extended':
                    return allMembers.filter(m => m.relationship === 'Extended');
                    
                default:
                    return allMembers.filter(m => m.isActive);
            }
        }

        function personalizeMessage(message, member) {
            const status = getMemberCurrentStatus(member.id);
            return message
                .replace(/{name}/g, member.name)
                .replace(/{firstName}/g, member.name.split(' ')[0])
                .replace(/{amount}/g, member.monthlyAmount)
                .replace(/{code}/g, member.accessCode)
                .replace(/{phone}/g, member.phone)
                .replace(/{paid}/g, status.paid)
                .replace(/{balance}/g, status.balance)
                .replace(/{status}/g, status.status)
                .replace(/{month}/g, getCurrentMonthName())
                .replace(/{business}/g, WHATSAPP_CONFIG.businessName);
        }

        function previewBroadcast() {
            const message = document.getElementById('broadcastMessage').value;
            const recipientType = document.getElementById('broadcastRecipients').value;
            
            if (!message.trim()) {
                alert('Please enter a message');
                return;
            }
            
            const members = getFilteredMembers(recipientType);
            
            if (members.length === 0) {
                alert('No members match the selected filter');
                return;
            }
            
            const sampleMember = members[0];
            const personalizedMessage = personalizeMessage(message, sampleMember);
            
            alert(`Preview for ${sampleMember.name}:\n\n${personalizedMessage}\n\nThis will be sent to ${members.length} members.`);
        }

        // WhatsApp History Logging
        function logWhatsAppMessage(memberId, type, message) {
            const logs = JSON.parse(localStorage.getItem('whatsappLogs') || '[]');
            logs.push({
                id: logs.length + 1,
                memberId: memberId,
                type: type,
                message: message.substring(0, 100) + (message.length > 100 ? '...' : ''),
                timestamp: new Date().toISOString(),
                status: 'sent'
            });
            localStorage.setItem('whatsappLogs', JSON.stringify(logs));
        }

        function loadWhatsAppHistory() {
            const logs = JSON.parse(localStorage.getItem('whatsappLogs') || '[]');
            const members = getMembers();
            const tbody = document.getElementById('whatsappHistoryBody');
            tbody.innerHTML = '';
            
            logs.slice(-10).reverse().forEach(log => {
                const member = members.find(m => m.id === log.memberId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(log.timestamp).toLocaleDateString()}</td>
                    <td>${member ? member.name : 'Unknown'}</td>
                    <td>${log.type}</td>
                    <td><span class="paid">${log.status}</span></td>
                    <td>
                        <button onclick="resendMessage(${log.id})" class="btn btn-sm btn-primary">
                            <i class="fas fa-redo"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function resendMessage(logId) {
            const logs = JSON.parse(localStorage.getItem('whatsappLogs') || '[]');
            const log = logs.find(l => l.id === logId);
            if (!log) return;
            
            const member = getMembers().find(m => m.id === log.memberId);
            if (member) {
                openWhatsAppWithMessage(member.phone, log.message);
            }
        }

        // WhatsApp Quick Actions
        function sendRemindersToUnpaid() {
            const unpaidMembers = getFilteredMembers('unpaid');
            if (unpaidMembers.length === 0) {
                alert('No unpaid members found');
                return;
            }
            
            if (!confirm(`Send reminders to ${unpaidMembers.length} unpaid members?`)) return;
            
            unpaidMembers.forEach((member, index) => {
                setTimeout(() => {
                    sendWhatsAppReminder(member);
                }, index * 2000);
            });
            
            alert(`Opening WhatsApp for ${unpaidMembers.length} unpaid members.`);
        }

        function sendMonthlyReports() {
            const members = getMembers();
            if (members.length === 0) {
                alert('No members found');
                return;
            }
            
            if (!confirm(`Send monthly reports to ${members.length} members?`)) return;
            
            members.forEach((member, index) => {
                setTimeout(() => {
                    const status = getMemberCurrentStatus(member.id);
                    const message = WHATSAPP_CONFIG.templates.monthly_report
                        .replace(/{firstName}/g, member.name.split(' ')[0])
                        .replace(/{month}/g, getCurrentMonthName())
                        .replace(/{totalMembers}/g, members.length)
                        .replace(/{collected}/g, getTotalCollectedThisMonth())
                        .replace(/{expected}/g, getTotalExpectedThisMonth())
                        .replace(/{rate}/g, getCollectionRate())
                        .replace(/{link}/g, window.location.href.split('#')[0])
                        .replace(/{business}/g, WHATSAPP_CONFIG.businessName);
                    
                    openWhatsAppWithMessage(member.phone, message);
                }, index * 3000);
            });
            
            alert(`Opening WhatsApp for ${members.length} members to send reports.`);
        }

        function shareAppLink() {
            const appUrl = window.location.href.split('#')[0];
            const message = `üè¶ ${WHATSAPP_CONFIG.businessName}\n\nAccess our family fund system:\n${appUrl}\n\nUse your access code to view your status.`;
            
            openWhatsAppWithMessage(WHATSAPP_CONFIG.phoneNumber, message);
        }

        function generateQRCode() {
            const appUrl = window.location.href.split('#')[0];
            const qrText = `${WHATSAPP_CONFIG.businessName}\n${appUrl}`;
            
            QRCode.toDataURL(qrText, {
                width: 300,
                margin: 1,
                color: {
                    dark: '#25D366',
                    light: '#FFFFFF'
                }
            }, function (err, url) {
                if (err) {
                    console.error(err);
                    return;
                }
                
                const win = window.open();
                win.document.write(`<img src="${url}" alt="QR Code" style="max-width: 100%;">`);
                win.document.title = 'App QR Code';
            });
        }

        function requestPaymentReminder() {
            if (!currentMember) return;
            
            const message = `üîî ${WHATSAPP_CONFIG.businessName} Reminder Request\n\nHello Admin,\n\nThis is ${currentMember.name}.\nPlease send me a payment reminder for this month.\n\nMy code: ${currentMember.accessCode}`;
            
            openWhatsAppWithMessage(WHATSAPP_CONFIG.phoneNumber, message);
        }

        function contactAdminWhatsApp() {
            const message = `üëã ${WHATSAPP_CONFIG.businessName} Inquiry\n\nHello Admin,\n\nI have a question about my contribution.\n\n${currentMember ? `Name: ${currentMember.name}\nCode: ${currentMember.accessCode}` : ''}`;
            
            openWhatsAppWithMessage(WHATSAPP_CONFIG.phoneNumber, message);
        }

        function testWhatsAppIntegration() {
            const testMessage = `‚úÖ ${WHATSAPP_CONFIG.businessName} Test\n\nWhatsApp integration is working!\n\nTest time: ${new Date().toLocaleString()}`;
            
            openWhatsAppWithMessage(WHATSAPP_CONFIG.phoneNumber, testMessage);
        }

        function saveWhatsAppSettings() {
            const reminderDays = parseInt(document.getElementById('reminderDays').value);
            const autoConfirm = document.getElementById('autoConfirm').value;
            
            const settings = JSON.parse(localStorage.getItem('whatsappSettings') || '{}');
            settings.reminderDays = reminderDays;
            settings.paymentConfirmations = autoConfirm === 'yes';
            
            localStorage.setItem('whatsappSettings', JSON.stringify(settings));
            alert('WhatsApp settings saved!');
        }

        // Utility Functions
        function getCurrentMonthName() {
            return new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        }

        function getMemberCurrentStatus(memberId) {
            const member = getMembers().find(m => m.id === memberId);
            const currentMonth = new Date().toISOString().slice(0, 7);
            const payments = getPayments().filter(p => 
                p.memberId === memberId && p.month === currentMonth
            );
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            const balance = member.monthlyAmount - totalPaid;
            const status = totalPaid >= member.monthlyAmount ? 'Paid' : 
                          totalPaid > 0 ? 'Partial' : 'Unpaid';
            
            return { paid: totalPaid, balance: balance, status: status };
        }

        function getUnpaidMembers() {
            const members = getMembers();
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            return members.filter(member => {
                const payments = getPayments().filter(p => 
                    p.memberId === member.id && p.month === currentMonth
                );
                const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
                return totalPaid < member.monthlyAmount;
            });
        }

        function getTotalCollectedThisMonth() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            const payments = getPayments().filter(p => p.month === currentMonth);
            return payments.reduce((sum, p) => sum + p.amount, 0);
        }

        function getTotalExpectedThisMonth() {
            const members = getMembers();
            return members.reduce((sum, m) => sum + m.monthlyAmount, 0);
        }

        function getCollectionRate() {
            const collected = getTotalCollectedThisMonth();
            const expected = getTotalExpectedThisMonth();
            return expected > 0 ? Math.round((collected / expected) * 100) : 0;
        }

        // Auto-reminder Scheduler
        function scheduleAutoReminders() {
            const today = new Date();
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            const daysUntilEnd = Math.floor((lastDay - today) / (1000 * 60 * 60 * 24));
            
            if (daysUntilEnd <= WHATSAPP_CONFIG.reminderDays) {
                const lastReminder = localStorage.getItem('lastAutoReminder');
                const todayStr = today.toDateString();
                
                if (lastReminder !== todayStr) {
                    if (confirm(`Send auto-reminders to unpaid members? (${daysUntilEnd} days until month end)`)) {
                        sendRemindersToUnpaid();
                        localStorage.setItem('lastAutoReminder', todayStr);
                    }
                }
            }
        }

        // Initialize WhatsApp features
        function initWhatsAppFeatures() {
            // Check for auto-reminders
            if (WHATSAPP_CONFIG.autoReminders) {
                setInterval(scheduleAutoReminders, 24 * 60 * 60 * 1000); // Check daily
                scheduleAutoReminders(); // Run once on load
            }
            
            // Load WhatsApp settings
            const savedSettings = JSON.parse(localStorage.getItem('whatsappSettings'));
            if (savedSettings) {
                document.getElementById('reminderDays').value = savedSettings.reminderDays || 5;
                document.getElementById('autoConfirm').value = savedSettings.paymentConfirmations ? 'yes' : 'no';
            }
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            showAdminLogin();
            initWhatsAppFeatures();
            
            // Check for WhatsApp parameters in URL
            const urlParams = new URLSearchParams(window.location.search);
            const whatsappCode = urlParams.get('whatsapp');
            const memberCode = urlParams.get('code');
            
            if (whatsappCode === 'true') {
                showWhatsAppAccess();
            } else if (memberCode) {
                document.getElementById('memberCode').value = memberCode;
                showMemberAccess();
            }
        });
    </script>
</body>
</html>
